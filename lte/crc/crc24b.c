#include "types.h"

#define __LTE_CRC24B_POLY__  (0x800063)  /* x^24 + x^23 + x^6 + x^5 + x + 1 */


static uint24 crc24b_table[256] = {
    0x000000, 0x800063, 0x8000A5, 0x0000C6, 0x800129, 0x00014A, 0x00018C, 0x8001EF,
    0x800231, 0x000252, 0x000294, 0x8002F7, 0x000318, 0x80037B, 0x8003BD, 0x0003DE,
    0x800401, 0x000462, 0x0004A4, 0x8004C7, 0x000528, 0x80054B, 0x80058D, 0x0005EE,
    0x000630, 0x800653, 0x800695, 0x0006F6, 0x800719, 0x00077A, 0x0007BC, 0x8007DF,
    0x800861, 0x000802, 0x0008C4, 0x8008A7, 0x000948, 0x80092B, 0x8009ED, 0x00098E,
    0x000A50, 0x800A33, 0x800AF5, 0x000A96, 0x800B79, 0x000B1A, 0x000BDC, 0x800BBF,
    0x000C60, 0x800C03, 0x800CC5, 0x000CA6, 0x800D49, 0x000D2A, 0x000DEC, 0x800D8F,
    0x800E51, 0x000E32, 0x000EF4, 0x800E97, 0x000F78, 0x800F1B, 0x800FDD, 0x000FBE,
    0x8010A1, 0x0010C2, 0x001004, 0x801067, 0x001188, 0x8011EB, 0x80112D, 0x00114E,
    0x001290, 0x8012F3, 0x801235, 0x001256, 0x8013B9, 0x0013DA, 0x00131C, 0x80137F,
    0x0014A0, 0x8014C3, 0x801405, 0x001466, 0x801589, 0x0015EA, 0x00152C, 0x80154F,
    0x801691, 0x0016F2, 0x001634, 0x801657, 0x0017B8, 0x8017DB, 0x80171D, 0x00177E,
    0x0018C0, 0x8018A3, 0x801865, 0x001806, 0x8019E9, 0x00198A, 0x00194C, 0x80192F,
    0x801AF1, 0x001A92, 0x001A54, 0x801A37, 0x001BD8, 0x801BBB, 0x801B7D, 0x001B1E,
    0x801CC1, 0x001CA2, 0x001C64, 0x801C07, 0x001DE8, 0x801D8B, 0x801D4D, 0x001D2E,
    0x001EF0, 0x801E93, 0x801E55, 0x001E36, 0x801FD9, 0x001FBA, 0x001F7C, 0x801F1F,
    0x802121, 0x002142, 0x002184, 0x8021E7, 0x002008, 0x80206B, 0x8020AD, 0x0020CE,
    0x002310, 0x802373, 0x8023B5, 0x0023D6, 0x802239, 0x00225A, 0x00229C, 0x8022FF,
    0x002520, 0x802543, 0x802585, 0x0025E6, 0x802409, 0x00246A, 0x0024AC, 0x8024CF,
    0x802711, 0x002772, 0x0027B4, 0x8027D7, 0x002638, 0x80265B, 0x80269D, 0x0026FE,
    0x002940, 0x802923, 0x8029E5, 0x002986, 0x802869, 0x00280A, 0x0028CC, 0x8028AF,
    0x802B71, 0x002B12, 0x002BD4, 0x802BB7, 0x002A58, 0x802A3B, 0x802AFD, 0x002A9E,
    0x802D41, 0x002D22, 0x002DE4, 0x802D87, 0x002C68, 0x802C0B, 0x802CCD, 0x002CAE,
    0x002F70, 0x802F13, 0x802FD5, 0x002FB6, 0x802E59, 0x002E3A, 0x002EFC, 0x802E9F,
    0x003180, 0x8031E3, 0x803125, 0x003146, 0x8030A9, 0x0030CA, 0x00300C, 0x80306F,
    0x8033B1, 0x0033D2, 0x003314, 0x803377, 0x003298, 0x8032FB, 0x80323D, 0x00325E,
    0x803581, 0x0035E2, 0x003524, 0x803547, 0x0034A8, 0x8034CB, 0x80340D, 0x00346E,
    0x0037B0, 0x8037D3, 0x803715, 0x003776, 0x803699, 0x0036FA, 0x00363C, 0x80365F,
    0x8039E1, 0x003982, 0x003944, 0x803927, 0x0038C8, 0x8038AB, 0x80386D, 0x00380E,
    0x003BD0, 0x803BB3, 0x803B75, 0x003B16, 0x803AF9, 0x003A9A, 0x003A5C, 0x803A3F,
    0x003DE0, 0x803D83, 0x803D45, 0x003D26, 0x803CC9, 0x003CAA, 0x003C6C, 0x803C0F,
    0x803FD1, 0x003FB2, 0x003F74, 0x803F17, 0x003EF8, 0x803E9B, 0x803E5D, 0x003E3E
};

void crc24b_gentab(const uint24 polynomial)
{
    uint24 accum;
    uint16 i, j;

    printf("\n");
    printf("polynomial: x^24 ");
    for (i=0, j=23; i<24; i++, j--)
    {
        if (polynomial & (0x1 << j))
        {
            if (0 == j)
            {
                printf("+ 1");
            }
            else if (1 == j)
            {
                printf("+ x ");
            }
            else
            {
                printf("+ x^%d ", j);
            }
        }
    }
    printf("\n");
    printf("\n");

    printf("[CRC24B Table]\n");
    for (i=0; i<256; i++)
    {
        accum = (i << 16);

        for (j=0; j<8; j++)
        {
            if (accum & 0x800000)
            {
                accum = (accum << 1) ^ polynomial;
            }
            else
            {
                accum = (accum << 1);
            }
        }

        crc24b_table[i] = (accum & 0xFFFFFF);

        if ((i != 0) && ((i % 8) == 0))
        {
            printf("\n");
        }
        printf(" 0x%06X,", (int)crc24b_table[i]);
    }
    printf("\n");
    printf("\n");
}

uint24 crc24b_checksum(const uint8 *data, const int len)
{
    uint24 crc = 0;
    int i, j;

    for (i=0; i<len; i++)
    {
       j = ((crc >> 16) ^ data[i]) & 0xff;
       crc = (crc << 8) ^ crc24b_table[j];

       #if 0
       printf("[%d] %02X, %06X\n", i, j, (crc & 0xFFFFFF));
       #endif
    }

    return (crc & 0xFFFFFF);
}

void bit_reverse(uint8 *input, uint8 *output, int size)
{
    int i, j;

    for (i=0, j=size-1; i<size; i++, j--)
    {
        output[i] = 0;

        output[i] |= ((input[j] & 0x01) << 7);
        output[i] |= ((input[j] & 0x02) << 5);
        output[i] |= ((input[j] & 0x04) << 3);
        output[i] |= ((input[j] & 0x08) << 1);
        output[i] |= ((input[j] & 0x10) >> 1);
        output[i] |= ((input[j] & 0x20) >> 3);
        output[i] |= ((input[j] & 0x40) >> 5);
        output[i] |= ((input[j] & 0x80) >> 7);
    }
}

int main(int argc, char *argv[])
{
    uint24  polynomial = __LTE_CRC24B_POLY__;
    uint8   rx_data[1024];
    int     rx_len;
    uint8   tx_data[] = {
    #if 1
        0xab, 0xcd,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34, 0x12,
        0x34
        //CRC24B: A7 D3 F5 (reversed AF CB E5)
    #endif
    #if 0
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x34,
        0x12, 0x99,
        0xAF, 0x25,
        0x5B
        //CRC24B: EF 6A C2 (reversed 43 56 F7)
    #endif
    };
    int     tx_len = sizeof( tx_data );
    uint24  crc = 0;
    uint24  crc_reverse = 0;


    //[1] generate CRC24B table
    if ((argc > 1) && (0 == strcmp("-g", argv[1])))
    {
        crc24b_gentab( polynomial );
        return 0;
    }

    //[2] calculate CRC24B checksum
    printf("Data length %d\n\n", tx_len);
    crc = crc24b_checksum(tx_data, tx_len);
    bit_reverse((uint8 *)&crc, (uint8 *)&crc_reverse, 3);
    printf("Calculate CRC24B : %06X (reversed %06X)\n", (int)crc, (int)crc_reverse);

    //[3] verify CRC24B checksum
    memcpy(rx_data, tx_data, tx_len);
    rx_data[tx_len+0] = (crc >> 16) & 0xFF;
    rx_data[tx_len+1] = (crc >>  8) & 0xFF;
    rx_data[tx_len+2] = (crc      ) & 0xFF;
    rx_len = tx_len + 3;
    crc = crc24b_checksum(rx_data, rx_len);
    printf("Verify remainder : %06X\n", (int)crc);

    return 0;
}

